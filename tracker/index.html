<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google" content="notranslate">
<link rel="stylesheet" href="style.css">

<script src="../wasm/rgbasm"></script>
<script src="../wasm/rgblink"></script>
<script src="../wasm/rgbfix"></script>
<script src="../js/lz-string.min.js"></script>
<script src="../js/jszip.min.js"></script>

<script src="../js/hardware.inc.js"></script>
<script src="../js/compiler.js"></script>
<script src="../js/emulator.js"></script>
<script src="../js/storage.js"></script>

<script src="../wasm/binjgb.js"></script>

<script src="js/song.js"></script>
<script src="js/ugeLoader.js"></script>
<script src="js/assemblyExport.js"></script>

<script src="js/ui/instruments.js"></script>

<script>
"use strict";

var song = new Song();
song.createDefaults();
var ui = {}

var noteName = ["C-", "C#", "D-", "D#", "E-", "F-", "F#", "G-", "G#", "A-", "A#", "B-"]
function noteToText(note)
{
    if (note === null) return "...";
    var octave = ~~(note / 12) + 3;
    return noteName[note % 12] + octave;
}
function instrumentNumberToText(instrument)
{
    if (instrument === null) return "..";
    return ("00" + (instrument + 1)).slice(-2);
}
function effectToText(effectcode, effectparam)
{
    if (effectcode === null) return "...";
    return effectcode.toString(16).toUpperCase() + ("00" + effectparam.toString(16).toUpperCase()).slice(-2);
}

function showPattern(index)
{
    var pattern = song.patterns[index];
    var tracker = document.getElementById("tracker");
    for(var index=0; index<pattern.length; index++)
    {
        var row_node = tracker.children[index+1];
        for(var track=0; track<4; track++)
        {
            var cell_node = row_node.children[track];
            var cell = pattern[index][track];
            cell_node.children[0].innerText = noteToText(cell.note);
            cell_node.children[1].innerText = instrumentNumberToText(cell.instrument);
            cell_node.children[2].innerText = effectToText(cell.effectcode, cell.effectparam);
        }
    }
}

function showSequence()
{
    var sequence = document.getElementById("sequence");
    while(sequence.children.length > 1)
        sequence.children[1].remove();
    for(var idx=0; idx<song.sequence.length; idx++)
    {
        var row_node = document.createElement("tr");
        var cell_node = document.createElement("td");
        cell_node.innerText = (idx + 1);
        row_node.appendChild(cell_node);
        cell_node = document.createElement("td");
        cell_node.innerText = song.sequence[idx];
        row_node.appendChild(cell_node);
        sequence.appendChild(row_node);
    }
}


window.addEventListener('DOMContentLoaded', (event) => {
    var tracker = document.getElementById("tracker");
    var header_row = document.createElement("tr");
    for(var col=0; col<4; col++)
    {
        var th_node = document.createElement("th");
        th_node.innerText = col;
        header_row.appendChild(th_node);
    }
    tracker.appendChild(header_row);

    for(var row=0; row<64; row++)
    {
        var row_node = document.createElement("tr");
        row_node.tabIndex = -1;
        for(var col=0; col<4; col++)
        {
            var cell_node = document.createElement("td");

            var note_span = document.createElement("span");
            note_span.innerText = "...";
            note_span.className = "note";
            var instrument_span = document.createElement("span");
            instrument_span.innerText = "..";
            instrument_span.className = "instrument";
            var effect_span = document.createElement("span");
            effect_span.innerText = "...";
            effect_span.className = "effect";

            cell_node.appendChild(note_span);
            cell_node.appendChild(instrument_span);
            cell_node.appendChild(effect_span);
            row_node.appendChild(cell_node);
        }
        tracker.appendChild(row_node);
    }
    
    document.getElementById("playButton").onclick = (event) => {
        storage.update("song.asm", exportSongAsAssembly(song));
        compiler.compile((rom_file, start_address, addr_to_line) => {
            emulator.init(null, rom_file);
            setInterval(() => {
                emulator.step("run");

                var addr = compiler.getRamSymbols().findIndex((v) => {return v == "current_order"});
                var current_pattern = emulator.readMem(addr) / 2;
                showPattern(current_pattern);

                var addr = compiler.getRamSymbols().findIndex((v) => {return v == "row"});
                var row = emulator.readMem(addr);
                tracker.children[row+1].focus();
            }, 10);
        });
    };
    
    compiler.setLogCallback(console.log);
    compiler.setLinkOptions(['-t', '-w']);
    function getFile(url, name)
    {
        var req = new XMLHttpRequest();
        req.open("GET", url, false);
        req.send();
        storage.update(name, req.response.replace(/include\//g, ""));
    }
    getFile("https://raw.githubusercontent.com/untoxa/hUGEBuild/master/player-rgbds/rgbds_player.z80", "main.asm");
    getFile("https://raw.githubusercontent.com/untoxa/hUGEBuild/master/driver_lite.z80", "driver_lite.asm");
    getFile("https://raw.githubusercontent.com/untoxa/hUGEBuild/master/include/constants.inc", "constants.inc");
    getFile("https://raw.githubusercontent.com/untoxa/hUGEBuild/master/include/music.inc", "music.inc");
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        document.body.addEventListener(eventName, function (e) {
            e.preventDefault()
            e.stopPropagation()
        }, false)
    });
    document.body.addEventListener("drop", function (e) {
        e.dataTransfer.files[0].arrayBuffer().then( (data) => {
            song = loadUGESong(data);
            console.log(song);
            showPattern(0);
            showSequence();
            ui.instruments.updateInstrumentList();
        });
    }, false)
    
    ui.instruments = new InstrumentUI();
});
</script>
</head>
<body>
<div class="container">
    <div class="instruments">
        <table id="instruments">
        <tr><th colspan="2">Instruments</th></tr>
        <tr><td colspan="2"><select id="instrumentSelector">
            <optgroup label="Duty"/>
            <optgroup label="Wave"/>
            <optgroup label="Noise"/>
        </select></td></tr>
        <tr><td>Name:</td><td><input id="instrumentName"/></td></tr>
        <tr><td>Length:<input type="checkbox" id="instrumentLengthEnabled"/></td><td><input id="instrumentLength" type="range" min="0" max="63" /></td></tr>

        <tr type="DN"><th colspan="2">Volume envelope</th></tr>
        <tr type="DN"><td>Initial volume:</td><td><input id="instrumentInitialVolume" type="range" min="0" max="15" /></td></tr>
        <tr type="DN"><td>Change:</td><td><input  id="instrumentVolumeChange" type="range" min="-7" max="7" /></td></tr>
        <tr type="DN"><td colspan="2"><canvas id="instrumentVolumeCanvas" width="300" height="50"/></td></tr>

        <tr type="D"><th colspan="2">Frequency sweep</th></tr>
        <tr type="D"><td>Sweep time:</td><td><select id="instrumentSweepTime"><option>Off</option><option>1/128Hz</option><option>2/128Hz</option><option>3/128Hz</option><option>4/128Hz</option><option>5/128Hz</option><option>6/128Hz</option><option>7/128Hz</option></select></td></tr>
        <tr type="D"><td>Sweep size:</td><td><input id="instrumentSweepChange" type="range" min="-7" max="7" /></td></tr>
        <tr type="D"><td colspan="2"><canvas id="instrumentSweepCanvas" width="300" height="50"/></td></tr>

        <tr type="D"><th colspan="2">Duty cycle</th></tr>
        <tr type="D"><td></td><td><select id="instrumentDuty"><option>12.5%</option><option>25%</option><option>50%</option><option>75%</option></select></td></tr>

        <tr type="W"><th colspan="2">Wave</th></tr>
        <tr type="W"><td>Volume</td><td><select id="instrumentWaveVolume"><option>Mute</option><option>100%</option><option>50%</option><option>25%</option></select></td></tr>
        <tr type="W"><td>Waveform</td><td><select id="instrumentWaveIndex"><option>1</option></select></td></tr>
        <tr type="W"><td colspan="2"><canvas id="instrumentWaveCanvas" width="300" height="100"/></td></tr>

        <tr type="N"><th colspan="2">Noise</th></tr>
        <tr type="N"><td>Shift clock mask</td><td><input id="instrumentNoiseShiftClockMask" type="range" min="0" max="15"/></td></tr>
        <tr type="N"><td>Dividing ratio</td><td><input id="instrumentNoiseDividingRatio" type="range" min="0" max="7"/></td></tr>
        <tr type="N"><td>7 bit counter</td><td><input id="instrumentNoise7bit" type="checkbox"/></td></tr>

        <tr><td></td><td><button>Test C-5</button></td></tr>

        </table>
    </div>
    <div class="sequence">
        <table id="sequence">
            <tr><th colspan="2">Sequence</th></tr>
        </table>
    </div>
    <div class="tracker"><table id="tracker"></table></div>
    <div class="controls">
        <button id="playButton">PLAY</button>
        <button id="stopButton">STOP</button>
    </div>
</div>
</body>
</html>
